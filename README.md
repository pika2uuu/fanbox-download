# Fanbox Downloader Neko

## TODO
- [ ] コンテントスクリプトはUIの表示用にして、ダウンロード処理は別のファイルにする
- 

## メモ
* ユーザーIDがあれば投稿一覧とプロフィールとプラン一覧のAPIは取得できる
* 投稿一覧はページネーションのapiを投げると、各ページのAPIが返ってくるので、さらにそのAPIを投げると1ページに表示される最大10個の投稿が返ってくる
* ログインしてなかったり支援金額が足りない状態だと bodyがnullで、タイトルは投稿日時など見える情報だけが入ったJSONが返ってくる。
* 投稿に一意のidを割り当ててAPIで取得してるが、ページのURLはそのID+ユーザIDをつけている。投稿にはユーザー情報も付け加えてるから使える。
* ダウンロード開始とダウンロード完了は別物。`chrome.downloads.download`はダウンロード開始するメソッド。ループをすると非同期に動くので、ダウンロードが完了してなくても次のループに進む。
* `chrome.downloads.download`で`conflictAction: 'uniquify'`を設定して同じページでダウンロードすると、フォルダに枝番が追加されるのではなく、ファイルに枝番が追加される。できたらフォルダに枝番が欲しい
* ダウンロードの進行状況は `progress`オブジェクトを作り、`percent`キーと`label`キーを作ると取扱いしやすい。
* ダウンロード済みの一覧表示はインデックスの他にダウンロード完了したときのstateとも関連するので条件分岐3回入りそう
* ダウンロードは全部一度にリクエストを投げる。ダウンロード進行画面にはいったん全てのファイル名を表示しておく。それでダウンロードが完了したファイルから順にリストの一番下に配置すればいいのでは。もしくはダウンロード済み配列で分けるとか
* dlQueueに入れるのではなく、1つのURLからダウンロード対象をまとめたらすぐにメッセージを送ってダウンロードできるようにする
* ダウンロードリストの一覧で、stateがinterruptedだったときにエラーメッセージを表示したい
## 未実装
* ダウンロード中の個数、ダウンロード済みの個数、ダウンロードエラーの個数を表示する
* JSON形式にするつもりで実装する。そうしたら各種類の投稿でdlListに入れてるが、データは連想配列に保管して、テキストとして保存するときは、プレゼンターの関数として別に実装する
* `https://api.fanbox.cc/plan.listSupporting` を使えばプランに入っているリストが取得できそうだから一気にダウンロードする機能を作れそう。

## 気づいたこと
* Background Script で fetch したのはBackgroundのDevToolsのNetworkタブ


## ダウンロード画面作成で気をつけたいこと
* ダウンロードクリックした状態と、ダウンロード完了か未完了状態、の２つを持ちたい。クリックしたあとダウンロード結果を常に表示しておきたい。
* `unieqfi`を設定しても枝番がつくのはフォルダの中のファイル。一番階層が浅いフォルダの時点で枝番をつけたい。まず初めにファイルではなくフォルダを作り、そのフォルダ名を指定すると言うことかな
* クリエイターページにいるときと、それ以外のページで挙動を変える。それ以外のページにいるときは一括ダウンロードする。


## 参考サイト

fanboxをダウンロードするスクリプト

https://github.com/darekasan/fanbox-downloader/blob/master/fanbox-downloader.js